%% Quick visualization of TRO's output (optimizer.cpp)
% clear all;

% the input cones file should be specified by user, 
% Germany2019 is given as example
file_path = 'Germany2019.txt';

% NLOP solution
problem = readtable('../data/problem.csv');
N = problem.Var1(1);
delta_s = problem.Var1(2);

n_states = 7;
n_controls = 2;
x_opt = readtable('../data/x_opt.csv');
x_opt = x_opt.Var1;

X_OPT = [0;0;x_opt(1:7)];
idu = 1;
idx = 1;
for k=1:N
    X_OPT = [X_OPT,[x_opt(n_states+N*n_states+idu:n_states+N*n_states+idu+1);x_opt(n_states+idx:2*n_states+idx-1)]];
    idu = idu+2;
    idx = idx+7;
end

% Trajectory
midline_points = readtable('../data/midline_points.csv');
optimal_points = readtable('../data/optimal_points.csv');

    % midline points generated by GRO.cpp
mid_x = midline_points.Var1;
mid_y = midline_points.Var2;

    % optimal points generated by TRO.cpp
x = optimal_points.Var1;
y = optimal_points.Var2;
vx = optimal_points.Var3;

% Detected cones
cones = readtable(file_path, 'FileType','text');

yellow_idx = find(cones.Var3==0);
blue_idx = find(cones.Var3==1);
yellow = [cones.Var1(yellow_idx) cones.Var2(yellow_idx)];
blue = [cones.Var1(blue_idx) cones.Var2(blue_idx)];

%% Odom PLOT
S = 0:delta_s:delta_s*N;

xopt_fig = figure();
subplot(2,2,1)
plot(S,X_OPT(7,:));
title('Vx');
xlabel('S [m]');
ylabel('Vx [m/s]');

subplot(2,2,2)
plot(S,X_OPT(3,:))
title('Delta');
xlabel('S [m]');
ylabel('delta [rad]');

subplot(2,2,3)
plot(S,X_OPT(8,:))
title('Vy');
xlabel('S [m]');
ylabel('Vy [m/s]');

subplot(2,2,4)
plot(S,X_OPT(9,:))
title('w');
xlabel('S [m]');
ylabel('w [rad/s]');
hold off

%% Trajectory PLOT

traj_fig = figure();
plot(mid_x, mid_y,'LineWidth',1);
hold on
plot([x; x(1)],[y; y(1)],'Color','k','LineWidth',1.5)
hold on
plot(mid_x(1), mid_y(1),'o', 'Color','#D95319');
hold on
plot(yellow(:,1),yellow(:,2),'o','Color','#EDB120','MarkerSize',5)
hold on
plot(blue(:,1),blue(:,2),'o','Color','#0072BD','MarkerSize',5)
title('Final Trajectory');
xlabel('x [m]');
ylabel('y [m]');
lgd = legend('Midline','Optimal','Starting point','Yellow cones','Blue cones');
fontsize(lgd,10,'points')
% saveas(traj_fig, "tro_traj.eps", "epsc");

%% Color PLOT

color_fig = figure();
coord_vx = [x,y,(1:size(x,1))',vx];
tbl = array2table(coord_vx,'VariableNames',{'x','y','idx','vx'});
% s = scatter(tbl,'x','y','filled','ColorVariable','vx');
s = scatter(tbl.x,tbl.y,20,tbl.vx,'filled');
colorbar
hold on
plot(yellow(:,1),yellow(:,2),'o','Color','#EDB120','MarkerSize',5)
hold on
plot(blue(:,1),blue(:,2),'o','Color','#0072BD','MarkerSize',5)
title('Velocity Profile');
xlabel('x [m]');
ylabel('y [m]');
% saveas(color_fig, "tro_colorplot.eps", "epsc");
    